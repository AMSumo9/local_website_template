---
import { Image } from 'astro:assets';
import BaseLayout from './BaseLayout.astro';
import projectData from '../data/project.json';
import { getCollection, type CollectionEntry } from 'astro:content';
import { getRelatedPosts } from '../utils/relatedPosts';
import AuthorBio from '../components/AuthorBio.astro';
import LeadMagnet from '../components/LeadMagnet.astro'; // <-- 1. IMPORT

export interface Props {
  frontmatter: Record<string, any>;
  slug: string; 
}

const { frontmatter, slug } = Astro.props; 
const siteData = projectData;
const {
  title,
  meta_description,
  date,
  featured_image,
  featured_image_alt,
  author = 'The Team',
  tags = [],
  categories = []
} = frontmatter;

const allPosts = await getCollection('posts');
const currentPost: CollectionEntry<'posts'> = {
  slug: slug, 
  data: { ...frontmatter, date: new Date(date) },
  body: '', 
  collection: 'posts',
  id: '', 
};
const relatedPosts = getRelatedPosts(allPosts, currentPost, 3); 

const pageData = { ...frontmatter, layout: 'posts' };
const displayDate = new Date(date).toLocaleDateString('en-AU', {
	year: 'numeric', month: 'long', day: 'numeric'
});

const authorName = (author.toLowerCase() === 'the team' || !author)
  ? siteData.persona?.expert_name || siteData.company.name
  : author;

const imageUrl = featured_image ? `/images/blog/${featured_image}` : '/images/blog/default.png';
const imageAlt = featured_image_alt || title;
const recentPosts = allPosts.sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf()).slice(0, 3);
---
<BaseLayout siteData={siteData} pageData={pageData}>

	<section class="bg-brand-accent">
		<div class="container mx-auto px-6 py-16 text-center">
			<h1 class="text-4xl font-extrabold text-[var(--text-primary)] mb-4">{title}</h1>
			<div class="flex flex-wrap justify-center items-center gap-x-6 gap-y-2 text-[var(--text-secondary)]">
				<span class="flex items-center">
					<i class="fas fa-calendar mr-2"></i>
					<time datetime={date}>{displayDate}</time>
				</span>
				<span class="flex items-center">
					<i class="fas fa-user mr-2"></i>
					{authorName}
				</span>
			</div>
		</div>
	</section>

	<section class="py-16 bg-white">
		<div class="container mx-auto px-6">
			<div class="max-w-4xl mx-auto">
				<div class="grid lg:grid-cols-5 gap-12">
					
          <div class="lg:col-span-3">
						<article class="prose lg:prose-lg max-w-none text-[var(--text-primary)] prose-headings:text-[var(--text-primary)] prose-a:text-brand-primary hover:prose-a:text-brand-primary-dark">
							 {featured_image && (
                <img src={imageUrl} alt={imageAlt} class="float-left mr-6 mb-4 max-w-[300px] rounded-lg shadow-md not-prose" loading="lazy" />
              )}
							<slot />
						</article>

            {siteData.persona?.expert_name && (
              <AuthorBio persona={siteData.persona} />
            )}
						
						{tags && tags.length > 0 && (
						<div class="mt-8 pt-6 border-t border-gray-200">
							<h3 class="text-lg font-semibold mb-3 text-[var(--text-primary)]">Tags</h3>
							<div class="flex flex-wrap gap-2">
								{tags.map(tag => (
									<span class="bg-brand-accent text-gray-800 px-3 py-1 rounded-full text-sm">
										#{tag}
									</span>
								))}
							</div>
						</div>
						)}
						
						<div class="mt-8 pt-6 border-t border-gray-200">
							<h3 class="text-lg font-semibold mb-4 text-[var(--text-primary)]">Share this article</h3>
							<div class="flex flex-wrap gap-2">
								<a href={`https://www.facebook.com/sharer/sharer.php?u=${Astro.url.href}`} target="_blank" class="flex items-center px-4 py-2 rounded-lg text-gray-800 hover:opacity-80 transition duration-200 bg-brand-accent">
									<i class="fab fa-facebook-f mr-2 text-brand-primary"></i> Facebook
								</a>
								<a href={`https://twitter.com/intent/tweet?url=${Astro.url.href}&text=${encodeURIComponent(title)}`} target="_blank" class="flex items-center px-4 py-2 rounded-lg text-gray-800 hover:opacity-80 transition duration-200 bg-brand-accent">
									<i class="fab fa-twitter mr-2 text-brand-primary"></i> Twitter
								</a>
								<a href={`https://www.linkedin.com/sharing/share-offsite/?url=${Astro.url.href}`} target="_blank" class="flex items-center px-4 py-2 rounded-lg text-gray-800 hover:opacity-80 transition duration-200 bg-brand-accent">
									<i class="fab fa-linkedin mr-2 text-brand-primary"></i> LinkedIn
								</a>
							</div>
						</div>

            <LeadMagnet />

            {relatedPosts.length > 0 && (
              <div class="mt-8 pt-6 border-t border-gray-200">
                <h2 class="text-2xl font-bold mb-4 text-[var(--text-primary)]">Related Resources</h2>
                <div class="space-y-4">
                  {relatedPosts.map(post => (
                    <a href={`/blog/${post.slug}/`} class="block p-4 rounded-lg bg-gray-50 hover:bg-brand-accent transition-colors">
                      <h4 class="font-semibold text-lg text-[var(--text-primary)] group-hover:text-brand-primary">
                        {post.data.title}
                      </h4>
                      <p class="text-sm text-[var(--text-secondary)] mt-1">
                        {post.data.excerpt || post.data.meta_description}
                      </p>
                    </a>
                  ))}
                </div>
              </div>
            )}
					</div>
					
          <aside class="lg:col-span-2">
						<div class="sticky top-24 space-y-6">
							<div class="bg-gray-50 p-6 rounded-lg shadow-md">
								<h3 class="text-xl font-bold mb-4 text-[var(--text-primary)]">Need Help?</h3>
								<p class="text-[var(--text-secondary)] mb-4">
									Have questions about finance? Our expert team is here to help.
								</p>
								<div class="flex flex-col gap-3">
									<button id="post-sidebar-open-modal" class="block w-full text-center px-4 py-3 rounded-lg font-bold transition duration-300 bg-brand-primary text-white hover:bg-brand-primary-dark">
										<i class="fas fa-edit mr-2"></i>
										Get A Quote
									</button>
									<a href={`tel:${siteData.contact.nap.phone_raw}`} class="block w-full text-center px-4 py-2 rounded-lg font-semibold transition duration-300 text-gray-800 bg-brand-accent hover:opacity-80">
										<i class="fas fa-phone mr-2"></i>
										Speak to an Expert
									</a>
								</div>
							</div>
							
							<div class="bg-gray-50 p-6 rounded-lg shadow-md">
								<h3 class="text-xl font-bold mb-4 text-[var(--text-primary)]">Recent Articles</h3>
								<div class="space-y-4">
									{recentPosts.map(post => (
										<a href={`/blog/${post.slug}/`} class="block group">
											<h4 class="font-semibold text-[var(--text-primary)] group-hover:text-brand-primary transition duration-200">
												{post.data.title}
											</h4>
											<p class="text-sm text-[var(--text-secondary)] mt-1">
                        {post.data.date.toLocaleDateString('en-AU', { year: 'numeric', month: 'long', day: 'numeric' })}
											</p>
										</a>
									))}
								</div>
							</div>
						</div>
					</aside>

				</div>
			</div>
		</div>
	</section>
</BaseLayout>