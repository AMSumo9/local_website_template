---
// src/layouts/LocationPage.astro
import { getCollection } from 'astro:content';
import BaseLayout from './BaseLayout.astro';
import ChildLocationGrid from '../components/ChildLocationGrid.astro';
import FaqAccordion from '../components/FaqAccordion.astro';
import AuthorBio from '../components/AuthorBio.astro';
import Testimonials from '../components/Testimonials.astro';
import Breadcrumbs from '../components/Breadcrumbs.astro';
import { getRelatedPostsForLocation } from '../utils/relatedContent';import { Image } from 'astro:assets';
import defaultLocationImage from '../assets/images/locations/default.png';
import projectData from '../data/project.json';

const siteData = projectData;

// Get all services (wrapped in try-catch for safety)
let allServices = [];
try {
  allServices = await getCollection('services');
} catch (error) {
  void console.warn('Services collection not found');
}

export interface Props {
  frontmatter: Record<string, any>;
  slug: string;
}

const { frontmatter, slug } = Astro.props;
const pageData = { ...frontmatter, layout: 'locations_v2' };

// --- DYNAMIC IMAGE LOOKUP WITH WATERFALL ---
// 1. Get all images from locations folder
const locationImages = import.meta.glob('../assets/images/locations/*.{png,jpg,jpeg,webp}', { eager: true });

// 2. Build expected filenames
const citySlug = frontmatter.city_name?.toLowerCase().replace(/\s+/g, '-') || slug.split('/').pop();
const serviceSlug = siteData.industry?.serviceName?.toLowerCase().replace(/\s+/g, '-') || 'broker';
const customFileName = `${citySlug}-${serviceSlug}`;
const autoFileName = `${citySlug}-${serviceSlug}-auto`;

// 3. Waterfall search: custom → auto → default
let imageUrl = defaultLocationImage;

// First, look for custom image (no -auto suffix)
for (const [path, module] of Object.entries(locationImages)) {
  if (path.includes(customFileName) && !path.includes('-auto')) {
    imageUrl = (module as any).default;
    break;
  }
}

// If not found, look for auto-generated
if (imageUrl === defaultLocationImage) {
  for (const [path, module] of Object.entries(locationImages)) {
    if (path.includes(autoFileName)) {
      imageUrl = (module as any).default;
      break;
    }
  }
}
const imageAlt = `Find a ${siteData.industry.serviceName} broker in ${frontmatter.city_name}`;

const lastUpdatedDate = frontmatter.last_updated
    ? new Date(frontmatter.last_updated).toLocaleDateString('en-AU', { year: 'numeric', month: 'long', day: 'numeric' })
    : null;

// Build breadcrumb items
const breadcrumbItems = [
  { name: 'Home', url: '/' },
  { name: 'Locations', url: '/locations/' },
];

if (!frontmatter.is_hub && slug.includes('/')) {
  const parentSlug = slug.split('/')[0];
  const parentName = parentSlug.charAt(0).toUpperCase() + parentSlug.slice(1);
  breadcrumbItems.push({ name: parentName, url: `/locations/${parentSlug}/` });
}

breadcrumbItems.push({ name: frontmatter.city_name, url: `/locations/${slug}/` });

// Fetch related blog posts for this location
const relatedPosts = await getRelatedPostsForLocation(frontmatter.city_name, 3);
---
<BaseLayout siteData={siteData} pageData={pageData}>

	<section class="bg-brand-accent">
		<div class="container mx-auto px-6 py-16 text-center">
			<h1 class="text-4xl md:text-5xl font-extrabold text-[var(--text-primary)] mb-4">
				Find {siteData.industry.serviceName} Brokers in <span class="text-brand-primary">{frontmatter.city_name}</span>
			</h1>
			{frontmatter.subtitle && (
				<p class="text-lg md:text-xl text-[var(--text-secondary)] max-w-3xl mx-auto">{frontmatter.subtitle}</p>
			)}
		</div>
	</section>

	<section class="bg-white border-b">
		<div class="container mx-auto px-6">
			<Breadcrumbs items={breadcrumbItems} />
		</div>
	</section>

	<section class="py-16 md:py-20 bg-white">
		<div class="container mx-auto px-6">
			<div class="max-w-6xl mx-auto">

				<div class="grid md:grid-cols-2 gap-x-12 gap-y-10 mb-16">
					<div class="self-start">
						<Image src={imageUrl} alt={imageAlt} width={800} height={600} class="w-full h-auto rounded-lg shadow-xl object-cover aspect-[4/3]" />
					</div>
					<div class="self-start">
						<h2 class="text-3xl font-bold text-[var(--text-primary)] mb-6">
							{siteData.industry.serviceName} Brokers Servicing the <span class="text-brand-primary">{frontmatter.city_name}</span> Area
						</h2>
						<article class="prose max-w-none text-[var(--text-secondary)]">
							<slot />
						</article>
					</div>
				</div>

				{frontmatter.is_hub && <ChildLocationGrid currentSlug={slug} city={frontmatter.city_name} />}

        <div class="mb-16">
          <h2 class="text-3xl font-bold text-[var(--text-primary)] text-center mb-12">
            Our Brokerage Services in <span class="text-brand-primary">{frontmatter.city_name}</span>
          </h2>
          <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-8">
            {allServices.map(service => (
              <a href={`/services/${service.slug}/`} class="block bg-gray-50 p-6 rounded-lg shadow-md hover:shadow-lg transition-shadow">
                {service.data.icon && <i class:list={[service.data.icon, "text-4xl text-brand-primary mb-4"]}></i>}
                <h3 class="text-xl font-semibold mb-2 text-[var(--text-primary)]">
                  {service.data.title.split(' | ')[0]}
                </h3>
                <p class="text-[var(--text-secondary)] mb-4">
                  {service.data.excerpt}
                </p>
                <span class="font-semibold text-brand-primary">
                  Learn More &rarr;
                </span>
              </a>
            ))}
          </div>
        </div>

				{frontmatter.key_benefits && frontmatter.key_benefits.length > 0 && (
					<div class="mb-16">
						<h2 class="text-3xl font-bold text-[var(--text-primary)] text-center mb-12">
							Why Choose Us in <span class="text-brand-primary">{frontmatter.city_name}</span>
						</h2>
						<div class="grid md:grid-cols-2 lg:grid-cols-3 gap-8">
							{frontmatter.key_benefits.map(benefit => (
								<div class="bg-gray-50 p-6 rounded-lg shadow-md">
									{benefit.icon && <i class:list={[benefit.icon, "text-4xl text-brand-primary mb-4"]}></i>}
									<h3 class="text-xl font-semibold mb-2 text-[var(--text-primary)]">{benefit.title}</h3>
									<p class="text-[var(--text-secondary)]">{benefit.description}</p>
								</div>
							))}
						</div>
					</div>
				)}

				{frontmatter.property_insights && frontmatter.property_insights.length > 0 && (
					<div class="mb-16">
						<h2 class="text-3xl font-bold text-[var(--text-primary)] text-center mb-4">
							{frontmatter.city_name} Property Market Insights
						</h2>
						{lastUpdatedDate && (
							<p class="text-center text-sm text-[var(--text-secondary)] italic mb-8">
								Market data last updated on {lastUpdatedDate}.
							</p>
						)}
						<div class="bg-gray-50 rounded-lg shadow-md p-6">
							<dl class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4">
								{frontmatter.property_insights.map(insight => (
									<div class="flex flex-col">
										<dt class="text-sm font-medium text-[var(--text-secondary)]">{insight.label}</dt>
										<dd class="text-lg font-semibold text-[var(--text-primary)]">
											{insight.value}
											{insight.source && <span class="text-xs font-normal text-gray-400 block">Source: {insight.source}</span>}
										</dd>
									</div>
								))}
							</dl>
						</div>
					</div>
				)}

        {siteData.persona?.expert_name && (
          <AuthorBio persona={siteData.persona} />
        )}

        <!-- ***** 2. ADD THE COMPONENT HERE ***** -->
        <Testimonials
          city_name={frontmatter.city_name}
          is_hub={frontmatter.is_hub}
          area_served={frontmatter.area_served}
        />

				<FaqAccordion faqs={frontmatter.faqs} />


				<div class="bg-brand-accent rounded-lg shadow-lg p-8 mt-20 text-center">
					<h2 class_name="text-3xl font-bold text-brand-primary mb-4">{siteData.cta.primary}</h2>
					<p class="text-lg text-[var(--text-secondary)] mb-6">Get personalised advice from our expert brokers today. It's free and there's no obligation.</p>
					<div class="space-y-4 md:space-y-0 md:space-x-4 md:flex md:justify-center">
						<a href={`tel:${siteData.contact.nap.phone_raw}`} class="inline-flex items-center justify-center text-gray-800 px-6 py-3 rounded-lg font-semibold transition duration-300 bg-white hover:opacity-80 shadow-sm">
						   <i class="fas fa-phone mr-2"></i> {siteData.cta.secondary}
						</a>
						<button id="location-cta-open-modal" class="inline-flex items-center justify-center text-gray-800 px-6 py-3 rounded-lg font-semibold transition duration-300 bg-white hover:opacity-80 shadow-sm">
						   <i class="fas fa-edit mr-2"></i> Submit Inquiry
						</button>
					</div>
				</div>

			</div>
		</div>
	</section>
        <!-- Related Blog Posts Section -->
        {relatedPosts.length > 0 && (
          <section class="py-12 bg-gray-50">
            <div class="container mx-auto px-6">
              <div class="max-w-6xl mx-auto">
                <h2 class="text-3xl font-bold text-[var(--text-primary)] text-center mb-8">
                  Related Articles About <span class="text-brand-primary">{frontmatter.city_name}</span>
                </h2>
                <div class="grid md:grid-cols-3 gap-8">
                  {relatedPosts.map(post => (
                    <a href={`/blog/${post.slug}/`} class="bg-white rounded-lg shadow-md hover:shadow-xl transition-shadow overflow-hidden">
                      {post.data.featured_image && (
                        <img 
                          src={`/images/blog/${post.data.featured_image}`} 
                          alt={post.data.title}
                          class="w-full h-48 object-cover"
                        />
                      )}
                      <div class="p-6">
                        <h3 class="text-xl font-semibold mb-2 text-[var(--text-primary)]">
                          {post.data.title.split(' | ')[0]}
                        </h3>
                        {post.data.excerpt && (
                          <p class="text-[var(--text-secondary)] text-sm mb-4">
                            {post.data.excerpt}
                          </p>
                        )}
                        <span class="text-brand-primary font-semibold text-sm">
                          Read More →
                        </span>
                      </div>
                    </a>
                  ))}
                </div>
              </div>
            </div>
          </section>
        )}

</BaseLayout>




